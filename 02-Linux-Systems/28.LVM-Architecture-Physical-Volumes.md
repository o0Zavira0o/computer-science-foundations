# LVM Architecture: Physical Volumes and System Construction

## Introduction
The Logical Volume Manager (LVM) is built like a pyramid. At the very bottom lies the **Physical Volume (PV)**.
While a Physical Volume might look like a simple hard drive to you, LVM treats it as a smart container. It stores not just data, but also **metadata**â€”the blueprints that describe how the entire storage system is connected.

In this guide, we will inspect Physical Volumes and then perform a complete construction: taking two unevenly sized raw disks and merging them into a perfect storage system.

---

## Part 1: Inspecting Physical Volumes

To manage Physical Volumes, we use two primary commands: `pvs` (summary) and `pvdisplay` (detailed).

### 1.1 The Summary View (`pvs`)
This command gives you a quick dashboard of your drives.

**The Columns:**
*   **PV:** The device name (e.g., `/dev/sda1`).
*   **VG:** The Volume Group this drive belongs to.
*   **Fmt:** The metadata format (usually `lvm2`).
*   **Attr:** Attributes. The most common is `a` (Allocatable), meaning LVM is allowed to put data here.
*   **PSize:** The total size of the physical drive.
*   **PFree:** The amount of space on this specific drive that is not yet part of a Logical Volume.

### 1.2 The Detailed View (`pvdisplay`)
This provides deep technical details, including the UUID.

**Key Concepts:**
*   **UUID:** A unique serial number. LVM relies on this, not the filename (`/dev/sda1`), to identify the disk. If you unplug drives and plug them in differently, LVM still knows which is which because of the UUID.
*   **PE (Physical Extent):** The smallest "block" LVM moves around.
    *   **Allocated PE:** Number of blocks currently holding data.
    *   **Free PE:** Number of blocks available.

**The Math of Usable Space:**
You might notice a drive says it is $10.00 \text{ GiB}$ but has $2.00 \text{ MiB}$ "not usable."
This happens because the Total Size is not perfectly divisible by the Extent Size ($PE_{size}$).
$$ \text{Unusable Space} = \text{Total Size} \pmod{PE_{size}} $$

---

## Part 2: Constructing a Logical Volume System (Theory)

Imagine you have two hard drives:
1.  **Drive A:** $5 \text{ GB}$
2.  **Drive B:** $15 \text{ GB}$

**The Goal:** You want to create two partitions of $10 \text{ GB}$ each.
**The Problem:** With standard partitioning, this is impossible. Drive A is too small to hold a 10GB partition.
**The Solution (LVM):**
1.  **Partition** both drives and tag them as LVM.
2.  **Initialize** them as Physical Volumes.
3.  **Merge** them into one Volume Group ($5 + 15 = 20 \text{ GB}$ Total).
4.  **Carve** two $10 \text{ GB}$ Logical Volumes from that big pool. LVM will handle the complex spanning of data across the disks.

---

## Part 3: Hands-on Lab (Step-by-Step)

In this lab, we will simulate the scenario described above. Since we cannot use 20GB of space in a quick lab, we will scale the numbers down but keep the proportions identical.

*   **Disk 1:** $200 \text{ MB}$ (Simulating the 5GB drive)
*   **Disk 2:** $600 \text{ MB}$ (Simulating the 15GB drive)
*   **Target:** Create two $400 \text{ MB}$ Logical Volumes.

**Note:** Run these commands in your Linux terminal (e.g., GitHub Codespaces).

### Step 1: Create Virtual Disks
We create blank files to act as our hard drives.

```bash
# Create Disk 1 (Small)
dd if=/dev/zero of=disk_small.img bs=1M count=200

# Create Disk 2 (Large)
dd if=/dev/zero of=disk_large.img bs=1M count=600

# Attach them to loop devices
# We save the device names to variables for easy use
DISK1=$(sudo losetup -fP --show disk_small.img)
DISK2=$(sudo losetup -fP --show disk_large.img)

echo "Created drives at $DISK1 and $DISK2"
```

### Step 2: Partition the Disks
We need to put a partition table on them and tag them as LVM. We will use `fdisk`.
*The Partition Type ID for LVM is **8e** (or `31` in new `gdisk` codes, but standard MBR uses 8e).*

**Partition Disk 1:**
```bash
# Use a heredoc to automate fdisk keystrokes
# n=new, p=primary, 1=partition number, defaults for size, t=type, 8e=LVM, w=write
sudo fdisk $DISK1 <<EOF
n
p
1


t
8e
w
EOF
```

**Partition Disk 2:**
```bash
sudo fdisk $DISK2 <<EOF
n
p
1


t
8e
w
EOF
```

### Step 3: Initialize Physical Volumes (PV)
Now we tell LVM to manage these new partitions. Note that `fdisk` created partitions like `/dev/loop0p1`.

```bash
# We add 'p1' to our device variables to target the partition, not the whole disk
sudo pvcreate ${DISK1}p1 ${DISK2}p1
```

### Step 4: Inspect the PVs
Let's look at what we created.

```bash
sudo pvs
```
**Observation:** You should see two PVs. One is approx 200MB, one is approx 600MB. Both belong to no VG yet.

### Step 5: Create the Volume Group (VG)
We merge them into a single pool called `mixed_vg`.

```bash
sudo vgcreate mixed_vg ${DISK1}p1 ${DISK2}p1
```

**Check the total size:**
```bash
sudo vgs mixed_vg
```
**Observation:** The `VSize` should be roughly $800 \text{ MB}$ ($200 + 600$).

### Step 6: Create the Logical Volumes (LV)
Now we achieve the "impossible." We create two $400 \text{ MB}$ volumes. The first one will fit easily on the large disk. The second one will force LVM to span across the remaining space of the large disk AND the small disk.

```bash
# Create first 400MB volume
sudo lvcreate -L 400M -n vol_A mixed_vg

# Create second 400MB volume
sudo lvcreate -L 400M -n vol_B mixed_vg
```

### Step 7: Verify the Final Structure
Let's see how LVM distributed the data using `pvs` again.

```bash
sudo pvs -o +pv_used
```
*(Note: `-o +pv_used` adds a column showing used space).*

**Observation:**
*   You will see that **both** drives are now fully used (Allocatable space is near 0).
*   We successfully created two identical volumes from two different-sized physical disks.

### Step 8: Detailed Inspection
Let's look at the metadata of the small drive.

```bash
sudo pvdisplay ${DISK1}p1
```
*   **Total PE:** $\approx 49$ (representing 200MB)
*   **Allocated PE:** $\approx 49$ (It is full)
*   **UUID:** The unique ID linking it to the group.

### Step 9: Clean Up
Remove the complex structure we built.

```bash
# Remove LVs
sudo lvremove -f mixed_vg

# Remove VG
sudo vgremove mixed_vg

# Remove PV labels
sudo pvremove ${DISK1}p1 ${DISK2}p1

# Detach loops
sudo losetup -d $DISK1
sudo losetup -d $DISK2

# Delete files
rm disk_small.img disk_large.img
```

# Master LVM: Creating Groups, Extending Storage, and Carving Partitions

## Introduction
In previous steps, you learned what Physical Volumes (PVs), Volume Groups (VGs), and Logical Volumes (LVs) are. Now, we will actually build them.

The process follows a specific workflow:
1.  **Initialize & Group:** Take a raw disk (partition), turn it into a Physical Volume, and create a Volume Group.
2.  **Extend:** Add a second disk to that group to make the pool bigger.
3.  **Carve:** Slice that big pool into usable Logical Volumes.

---

## Part 1: Creating the Volume Group (`vgcreate`)

The command `vgcreate` is a powerful tool. It does two things at once:
1.  It initializes the disk as a Physical Volume (PV).
2.  It creates the Volume Group (VG) using that disk.

**Syntax:**
$$ \texttt{vgcreate [Name of Group] [Path to Device]} $$

**Example:**
`vgcreate my_pool /dev/sdb1`

**Troubleshooting:**
If you run `vgs` (to list groups) immediately after creating one and don't see it, you might need to force the system to rescan the hardware:
$$ \texttt{pvscan} $$

---

## Part 2: Extending the Group (`vgextend`)

One of the best features of LVM is the ability to grow storage. If you buy a new hard drive (`/dev/sdc1`), you don't need to create a separate pool. You can just glue it onto your existing group.

**Syntax:**
$$ \texttt{vgextend [Existing Group Name] [New Device]} $$

**The Math:**
If Disk A is 5GB and Disk B is 15GB:
$$ \text{Volume Group Size} = 5\text{GB} + 15\text{GB} = 20\text{GB} $$

---

## Part 3: Creating Logical Volumes (`lvcreate`)

Now that you have a large pool of storage (VG), you need to carve out the virtual partitions (LV) that the operating system will actually use.

**Syntax:**
$$ \texttt{lvcreate --size [Size] --type linear -n [Name] [Group Name]} $$

*   **--size:** You can specify `10G`, `500M`, etc.
*   **--type linear:** This is the default method. It just fills up the physical drives one by one. You can usually skip typing this part.
*   **-n:** The name you want to give the volume (e.g., `data`, `logs`).

**Why is there leftover space?**
LVM divides data into chunks called **PEs (Physical Extents)**, usually 4MB in size.
If you ask for a size that isn't perfectly divisible by 4MB, or if the physical disk size isn't a perfect multiple, you might end up with a tiny amount of "Free PE" (unused space) at the end. This is normal.

---

## Part 4: Hands-on Lab (LVM Construction)

In this lab, we will simulate the exact scenario of taking two separate disks, merging them, and creating two logical volumes. Since we are in a cloud terminal, we will scale the sizes down (using MB instead of GB), but the commands function exactly the same.

**Note:** Run these commands as `root` (use `sudo`).

### Step 1: Create Virtual Disks
We need two "hard drives." We will create one small one (simulating 5GB) and one large one (simulating 15GB).

```bash
# Create "Disk A" (50MB)
dd if=/dev/zero of=disk_small.img bs=1M count=50

# Create "Disk B" (150MB)
dd if=/dev/zero of=disk_large.img bs=1M count=150

# Attach them to the system as loop devices
# We capture the device names (like /dev/loop0) into variables
DISK_A=$(sudo losetup -fP --show disk_small.img)
DISK_B=$(sudo losetup -fP --show disk_large.img)

echo "Drives created at: $DISK_A and $DISK_B"
```

### Step 2: Create the Volume Group (`vgcreate`)
We will take **Disk A** and turn it into a volume group named `my_storage`.

```bash
# Syntax: vgcreate [Name] [Device]
sudo vgcreate my_storage $DISK_A
```

*Check your work:*
```bash
sudo vgs
```
*Observation: You should see `my_storage` with a VSize of roughly 46-48MB.*

### Step 3: Add the Second Disk (`vgextend`)
Now we add **Disk B** to the pool to make it bigger.

```bash
# Syntax: vgextend [Group Name] [New Device]
sudo vgextend my_storage $DISK_B
```

*Check your work:*
```bash
sudo vgs
```
*Observation: The VSize should jump to roughly 190MB-200MB. We successfully merged two separate drives!*

### Step 4: Create Logical Volumes (`lvcreate`)
Now we will carve out two volumes, 80MB each.
*   Note: Disk A is only 50MB. This means the first volume will physically span across Disk A *and* part of Disk B. LVM handles this automatically.

```bash
# Create first volume named 'vol_1'
sudo lvcreate --size 80M -n vol_1 my_storage

# Create second volume named 'vol_2'
sudo lvcreate --size 80M -n vol_2 my_storage
```

### Step 5: Verify the Structure (`vgdisplay`)
Let's look at the deep details of our group now.

```bash
sudo vgdisplay my_storage
```

**What to look for in the output:**
1.  **Cur PV (Current Physical Volumes):** Should be **2**.
2.  **Cur LV (Current Logical Volumes):** Should be **2**.
3.  **Alloc PE / Size:** This shows how much space is used (approx 160MB).
4.  **Free PE / Size:** This shows leftover space. Since $50+150 = 200$, and we used $80+80=160$, you should have roughly 30-40MB free.

### Step 6: Verify the Logical Volumes (`lvs`)
```bash
sudo lvs
```
*Observation: You will see `vol_1` and `vol_2` listed with LSize of 80.00m.*

### Step 7: Clean Up
It is important to remove these virtual devices when finished.

```bash
# 1. Remove the logical volumes
sudo lvremove -f my_storage

# 2. Remove the volume group
sudo vgremove my_storage

# 3. Remove physical volume labels
sudo pvremove $DISK_A $DISK_B

# 4. Detach loop devices
sudo losetup -d $DISK_A
sudo losetup -d $DISK_B

# 5. Delete the fake disk files
rm disk_small.img disk_large.img
```