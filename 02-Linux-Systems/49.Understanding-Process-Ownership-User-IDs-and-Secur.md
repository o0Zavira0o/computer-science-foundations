## Understanding Process Ownership, User IDs, and Security Implications

---

## 1) Understanding User IDs in Linux: **Real UID**, **Effective UID**, and **Saved UID**

### 1.1 What are User IDs (UIDs)?

Linux assigns different **user IDs** (UIDs) to users and processes. Every process has several related IDs:

1. **Real UID (ruid)**: The user who initiated the process.
2. **Effective UID (euid)**: Defines the permissions for the process (important for file access).
3. **Saved UID (suid)**: A backup of the euid, used when switching UIDs during execution.

Normally, the `ruid` and `euid` are the same, but they differ in special cases like when using `setuid` programs.

---

### 1.2 Simplified Explanation

* **ruid** is like the **owner** of the process (who started it).
* **euid** is like the **actor** performing actions with the permissions of the owner.

Example:

* A user A runs a program that has setuid permissions, and this program runs as user B.
* Even though the program runs as user B (euid), user A (ruid) still owns the process and can kill it.

### 1.3 Command to View User IDs

To view the **ruid** and **euid** of processes, use `ps`:

```bash
ps -eo pid,euser,ruser,comm
```

This shows:

* **euser**: The effective user (current permissions)
* **ruser**: The real user (who started the process)

---

### 1.4 Hands-On: Inspect Process Ownership and UIDs (New Example)

#### Exercise A — View process UIDs

1. **Run a test process**:

```bash
sleep 60 &
```

2. **List your running processes**:

```bash
ps -eo pid,euser,ruser,comm
```

You will see the `euser` (effective user) and `ruser` (real user) columns, which are usually identical for most processes.

---

## 2) Real vs Effective UIDs: The Setuid Program Example

### 2.1 Setuid Program Behavior

When a setuid program runs, it temporarily **changes** the **effective UID** (euid) to the owner of the program, but keeps the **real UID** (ruid) as the user who started it.

Example: If you run a setuid program as a normal user, it may run with elevated privileges, but your **real UID** remains the same, and only the **effective UID** is modified.

---

### 2.2 Hands-On: Create a Setuid Program (Safe Testing)

#### Exercise B — Test with a setuid version of `sleep`

1. **Create a simple copy of `sleep`** (requires root):

```bash
sudo cp /bin/sleep /tmp/sleep_test
```

2. **Set the setuid bit** to make it run with root’s privileges:

```bash
sudo chmod u+s /tmp/sleep_test
```

3. **Check the file’s permissions**:

```bash
ls -l /tmp/sleep_test
```

You’ll see an `s` in the permissions field for the owner, indicating setuid is set.

4. **Run the program and check the UIDs**:

```bash
/tmp/sleep_test 10 &
ps -eo pid,euser,ruser,comm
```

You’ll see that the process runs with an **euid** of root, but the **ruid** remains your user.

---

## 3) Security Implications of Setuid Programs

### 3.1 Security Concerns

A process running with setuid permissions **temporarily has the privileges** of the file owner (often root). If these programs have bugs, they could be exploited by an attacker to escalate privileges. This is why you should **limit** the number of setuid programs and be cautious when creating them.

### 3.2 Example: Dangerous Setuid Programs

If you accidentally create a setuid program from a shell (like `bash`), any user could **run a root shell** by executing it, compromising the system.

#### Exercise C — See the dangers of setuid with `bash`

1. **Copy bash and setuid it**:

```bash
sudo cp /bin/bash /tmp/bash_test
sudo chmod u+s /tmp/bash_test
```

2. **Verify the permissions**:

```bash
ls -l /tmp/bash_test
```

3. **Run the setuid bash**:

```bash
/tmp/bash_test
```

You should now be running a root shell because the `bash_test` program is setuid to root.

4. **Exit**:

```bash
exit
```

Make sure to **remove the setuid** program afterward to avoid security issues:

```bash
sudo rm /tmp/bash_test
```

---

## 4) Switching Between User IDs

### 4.1 Why You Can’t Always Use `kill` on a Process You Started

Even if you started a process, you may **not** be able to kill it if it’s running with different permissions. This is because of the `ruid`/`euid` distinction.

### 4.2 Example: Killing a Setuid Process

Let’s say you started a process with `setuid` and it’s running as root (euid), but you can still **kill it** because your user owns the process (ruid).

---

## 5) Hands-On: Process Ownership and Killing

#### Exercise D — Kill a Setuid Process (Testing Permissions)

1. **Start a process that runs as root**:

```bash
sudo /tmp/sleep_test 10 &
```

2. **Verify it’s running**:

```bash
ps -eo pid,euser,ruser,comm | grep sleep
```

3. **Try killing it as a normal user**:

```bash
kill <pid_of_sleep_test>
```

Since the process is running as root, you can still **kill it** because your **real UID** (ruid) matches the process owner.

---

## 6) The Saved UID and File System UID

### 6.1 What is the Saved UID?

The **saved UID** (suid) is a copy of the **effective UID** (euid). A process can use `setuid()` to switch between these values. This feature is used for more complex scenarios but isn’t often seen in normal system operations.

### 6.2 What is the File System UID?

The **file system UID** (fsuid) defines the user accessing the file system, and it is rarely used directly.

---

## 7) Managing User Authentication, Identification, and Authorization

### 7.1 The Three Key Aspects of User Security

1. **Identification**: Who is the user (via UID)?
2. **Authentication**: Prove who you are (via passwords, SSH keys, etc.).
3. **Authorization**: What are you allowed to do (permissions)?

### 7.2 How Linux Handles User Authentication

* The kernel only cares about **numeric UIDs** and **permissions** for files and processes.
* The kernel does **not** handle usernames or passwords; this happens in **user-space** via tools like `passwd`, `sshd`, etc.

---

## 8) Hands-On: Identify and Authenticate Your User

#### Exercise E — View your UID and Username

1. **Check your UID**:

```bash
id -u
```

2. **Find your username**:

```bash
id -un
```

3. **Check the system's user database** (`/etc/passwd`):

```bash
grep "^$(id -un):" /etc/passwd
```

---

### 8.1 Authentication Process 

1. **Process requests UID** via `geteuid()`.
2. **Look up UID in `/etc/passwd`** and fetch the corresponding username.

In practice, most programs interact with `/etc/passwd` or network-based services (e.g., LDAP) to map the UID to a username for user-friendly identification.

---

## 9) Conclusion and Key Takeaways

* **Real UID (ruid)**: Who started the process.
* **Effective UID (euid)**: The privileges the process has during execution (for file access, etc.).
* **Saved UID (suid)**: A backup of euid, used for switching during process execution.
* **Security**: Be very cautious with setuid programs; they can lead to privilege escalation if misused.
* **User authentication** (passwords, SSH keys) happens in user-space, not in the kernel.


