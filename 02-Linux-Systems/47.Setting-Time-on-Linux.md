## Setting Time on Linux (RTC, system clock, time zones, NTP) + Intro to Cron Scheduling (with Fresh Terminal Demos)

---

## 1) Two clocks you must understand: **system clock** vs **hardware clock (RTC)**

### 1.1 System clock (kernel clock)

* Maintained by the **kernel**
* Used by commands like:

```bash
date
```

Internally, the kernel represents time as:

$$
\text{seconds since } 1970\text{-}01\text{-}01\ 00{:}00{:}00\ \text{UTC}
$$

You can view that raw number:

```bash
date +%s
```

---

### 1.2 Hardware clock (RTC)

PCs have a battery-backed **Real-Time Clock** (RTC). At boot, the kernel often initializes the system clock from the RTC.

Key best practice:

$$
\text{Keep the hardware clock in UTC}
$$

Why? It avoids DST/timezone confusion.

---

## 2) Hands-on: inspect both clocks safely (no changes)

### Exercise A — Compare system time vs RTC time

**Step 1: Show system time (human-readable + timezone)**

```bash
date
```

**Step 2: Show system time in UTC**

```bash
date -u
```

**Step 3: Show RTC time**

```bash
sudo hwclock --show
```

**What you learn**

* If RTC is kept in UTC, it should resemble `date -u` (maybe with small difference).
* If RTC is kept in local time, it will resemble `date` instead.

---

## 3) Why you usually should NOT set time using `date`

You *can* set the system time using `date`, but it’s usually a bad idea because:

* Humans won’t get it exactly right
* Jumping time forward/back can break time-based tasks (timers, cron jobs, cert validation, logs)

Instead, you typically rely on **network time synchronization**.

---

## 4) Resetting RTC from system time (the safe direction)

If your system time is already correct (usually via NTP), you can copy it into the hardware clock:

$$
\text{RTC} \leftarrow \text{System time}
$$

Command (UTC hardware clock):

```bash
sudo hwclock --systohc --utc
```

### Hands-on: verify before and after (observe only)

**Step 1: Check both clocks**

```bash
date -u
sudo hwclock --show
```

**Step 2: Sync RTC from system time**

```bash
sudo hwclock --systohc --utc
```

**Step 3: Re-check**

```bash
date -u
sudo hwclock --show
```

---

## 5) Time zones: `/etc/localtime`, `zoneinfo`, and `TZ`

### 5.1 The system timezone

The system’s local time zone is determined by:

$$
/etc/localtime
$$

It’s a binary timezone data file (not meant for viewing).

Timezone database files live in:

$$
/usr/share/zoneinfo
$$

---

### 5.2 Hands-on: identify your current timezone configuration

**Step 1: See the configured timezone (systemd systems)**

```bash
timedatectl
```

Look for:

* `Time zone: ...`
* `System clock synchronized: ...`
* NTP status indicators

**Step 2: See what `/etc/localtime` points to**
Many systems make `/etc/localtime` a symlink:

```bash
ls -l /etc/localtime
```

If it’s a symlink, it often points into `/usr/share/zoneinfo/...`.

---

### 5.3 Temporary timezone changes with `TZ` (no permanent changes)

#### Set timezone for just one command

```bash
TZ=US/Central date
```

#### Set timezone for your current shell session

```bash
export TZ=US/Central
date
```

To undo for the session:

```bash
unset TZ
date
```

### Hands-on: compare two zones instantly (quick intuition)

```bash
date
TZ=UTC date
TZ=Asia/Tokyo date
```

---

## 6) Network time sync (NTP): `systemd-timesyncd` and status checks

### 6.1 Why network time matters

Machines drift because oscillators aren’t perfect.

$$
\text{drift} = \text{system time} - \text{true time}
$$

NTP daemons correct drift gradually (or with careful stepping), keeping time accurate.

### 6.2 Hands-on: check if your system is syncing time

**Step 1: Check sync and NTP settings**

```bash
timedatectl status
```

**Step 2: Check timesyncd status (if installed)**

```bash
systemctl status systemd-timesyncd --no-pager
```

**Step 3: See the server currently used (common on systemd systems)**

```bash
timedatectl show-timesync --all 2>/dev/null || echo "show-timesync not available on this system"
```

If your distro uses `chronyd` instead, you can check it with:

```bash
systemctl status chronyd --no-pager
```

---

## 7) Cron basics: scheduling recurring tasks

### 7.1 Cron job = command run on a schedule

A cron entry format:

$$
\text{minute}\ \text{hour}\ \text{day-of-month}\ \text{month}\ \text{day-of-week}\ \ \text{command}
$$

Example:

```text
15 09 * * * /home/juser/bin/spmake
```

Meaning:

$$
09{:}15 \text{ every day}
$$

Field ranges:

* minute: (0)–(59)
* hour: (0)–(23)
* day of month: (1)–(31)
* month: (1)–(12)
* day of week: (0)–(7) (0 and 7 are Sunday)

A `*` means “every value.”

---

## 8) Hands-on: create a safe learning cron job 

> This demo creates a small script that writes a timestamp to a file, schedules it, then lets you verify it ran.
> It does **not** rely on mail and doesn’t need system-wide changes.

### Exercise B — Create a simple script that logs time to a file

**Step 1: Create a script**

```bash
mkdir -p "$HOME/bin"
cat > "$HOME/bin/cron_time_demo.sh" <<'EOF'
#!/usr/bin/env bash
echo "cron ran at: $(date -Is) (TZ=${TZ:-system-default})" >> "$HOME/cron_time_demo.log"
EOF
chmod +x "$HOME/bin/cron_time_demo.sh"
```

**Step 2: Test it manually**

```bash
"$HOME/bin/cron_time_demo.sh"
tail -n 5 "$HOME/cron_time_demo.log"
```

You should see a new line appended.

---

### Exercise C — Install a cron job that runs every minute (temporary learning)

**Step 1: View your current crontab**

```bash
crontab -l 2>/dev/null || echo "No crontab yet"
```

**Step 2: Add a job that runs every minute**
This keeps any existing jobs and appends a new one:

```bash
( crontab -l 2>/dev/null; echo "* * * * * $HOME/bin/cron_time_demo.sh" ) | crontab -
```

**Step 3: Confirm it’s installed**

```bash
crontab -l
```

**Step 4: Wait about 1–2 minutes, then check the log**

```bash
tail -n 10 "$HOME/cron_time_demo.log"
```

You should see new timestamps appear each minute.

---

### Exercise D — Clean up (remove the demo job)

To remove only the demo line:

```bash
crontab -l | grep -v 'cron_time_demo.sh' | crontab -
```

Verify it’s gone:

```bash
crontab -l
```

---

## 9) Why time accuracy matters for cron (the link between topics)

Cron uses **local time**. If the system clock is wrong or the timezone is misconfigured:

* jobs may run at unexpected times
* DST changes can cause skips or repeats

That’s why:

$$
\text{Accurate NTP + correct timezone} \Rightarrow \text{reliable scheduling}
$$

---