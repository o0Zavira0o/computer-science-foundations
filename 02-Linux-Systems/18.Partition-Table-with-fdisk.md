# Creating a Partition Table with `fdisk`

In the previous sections, we learned the theory. Now, we will walk through the exact process of taking a generic disk (like a USB stick), wiping it clean, and slicing it into two usable sections using the `fdisk` command.

This is the standard procedure for preparing new hard drives or repurposing old ones.

---

## 1. The `fdisk` Vocabulary
`fdisk` is interactive. You talk to it using single letters. Here is your "Cheat Sheet" for the commands used :

*   **`p` (Print):** Show me the current status of the disk.
*   **`d` (Delete):** Remove an existing partition (wipe a slice).
*   **`n` (New):** Create a new partition.
*   **`w` (Write):** Save changes to the disk and exit. (The "Commit" button).
*   **`q` (Quit):** Exit **without** saving. (The "Undo/Panic" button).

## 2. The Workflow Explained
As an example we have a **4GB USB drive** located at `/dev/sdd`. We want to create:
1.  A **200MB** partition (e.g., for Boot files).
2.  A **3.8GB** partition (the rest of the disk for Data).

### Phase 1: Inspection and Cleaning
1.  **`fdisk /dev/sdd`**: Starts the program.
2.  **`p`**: The user checks the disk. They see an existing `W95 FAT32` partition.
3.  **`d`**: The user decides to delete it. The disk is now effectively "Empty" in the workspace (but not yet on the physical hardware).

### Phase 2: Creation
1.  **`n`**: "I want a new partition."
2.  **`p`**: "Make it Primary."
3.  **`1`**: "This is Partition #1."
4.  **`2048`**: "Start at the beginning" (Default).
5.  **`+200M`**: "Make it 200 Megabytes long." *Note the `+` sign.*

*(Repeat for the second partition, accepting defaults to use the remaining space).*

### Phase 3: Commitment
1.  **`p`**: Review the work. The table now shows `sdd1` (200MB) and `sdd2` (3.8GB).
2.  **`w`**: The user types write. The program calls `ioctl()`‚Äîthis sends a signal to the Linux Kernel saying, "Reload your map, the disk changed!"

---

# üõ†Ô∏è Hands-On Lab: GitHub Codespaces

Since we cannot plug a physical USB stick into the cloud, we will create a "Virtual 1GB USB Stick" and partition it exactly like the tutorial.

### Step 1: Create the Virtual Device
We will create a file filled with zeros and attach it as a Loop device.

```bash
# 1. Create a 1GB empty file (1024MB)
dd if=/dev/zero of=usb_stick.img bs=1M count=1024

# 2. Attach it to a device node
# We save the name (e.g., /dev/loop0) into a variable called $DISK
DISK=$(sudo losetup -fP --show usb_stick.img)

# 3. Print the name so you know what we are working on
echo "Your virtual USB stick is located at: $DISK"
```

### Step 2: Start `fdisk`
Now we enter the interactive menu.
*(Note: Since this is a raw file, it doesn't have an MBR table yet. We will create one with the `o` command first).*

```bash
sudo fdisk $DISK
```

**Perform the following keystrokes inside the menu:**

1.  **Create the Label:**
    *   Type **`o`** and press **Enter**.
    *   *(Output: Created a new DOS disklabel...)*

2.  **Create Partition 1 (The Small One):**
    *   Type **`n`** (New) $\to$ **Enter**.
    *   Type **`p`** (Primary) $\to$ **Enter**.
    *   Type **`1`** (Partition 1) $\to$ **Enter**.
    *   **Enter** (Accept default First Sector).
    *   Type **`+200M`** (Size) $\to$ **Enter**.
    *   *(Output: Created a new partition 1 of type 'Linux' and of size 200 MiB).*

3.  **Create Partition 2 (The Rest of the Disk):**
    *   Type **`n`** (New) $\to$ **Enter**.
    *   Type **`p`** (Primary) $\to$ **Enter**.
    *   Type **`2`** (Partition 2) $\to$ **Enter**.
    *   **Enter** (Accept default First Sector).
    *   **Enter** (Accept default Last Sector to fill the disk).

4.  **Review (Verify):**
    *   Type **`p`** (Print) $\to$ **Enter**.
    *   *Look for `loopXp1` (200M) and `loopXp2` (823M).*

5.  **Commit (Write):**
    *   Type **`w`** (Write) $\to$ **Enter**.
    *   *(Output: The partition table has been altered. Syncing disks.)*

### Step 3: Verify the Kernel's View
The text mentioned `ioctl()` syncing the disks. Let's verify that the Linux Kernel sees our new slices.

```bash
# List block devices
lsblk $DISK
```
**Observation:**
You should see the hierarchy:
*   `loopX` (1G)
    *   `‚îî‚îÄloopXp1` (200M)
    *   `‚îî‚îÄloopXp2` (823M)

### Step 4: Check Kernel Logs (Optional)
Here we use `journalctl -k` to see the diagnostic messages.

```bash
# Check the last 10 lines of the kernel log
sudo dmesg | tail -n 10
```
**Observation:**
You might see lines like: `loop0: p1 p2`, confirming the kernel detected the change.

### Step 5: Cleanup
```bash
sudo losetup -D
rm usb_stick.img
```