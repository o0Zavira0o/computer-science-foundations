## Managing User Crontabs, System Cron, and Creating a systemd Timer + Service

---

## 1) User crontabs: what they are and how they’re installed

### 1.1 Concept

Each user can have a personal scheduled task list called a **crontab**.

$$
\text{User crontab} ; \xrightarrow{\text{managed by }} \texttt{crontab} \text{ command}
$$

On many systems, the installed per-user crontab files live under something like:

$$
/var/spool/cron \quad \text{or} \quad /var/spool/cron/crontabs
$$

Normal users usually **can’t** directly write there; the `crontab` command is the safe interface.

---

## 2) Hands-on: install a user crontab from a file 

> This demo schedules a task that appends a timestamped line to a file in your home directory.

### Exercise A — Create a new cron target script (fresh)

**Step 1: Create a script that appends a line**

```bash
mkdir -p "$HOME/bin"
cat > "$HOME/bin/cron_file_install_demo.sh" <<'EOF'
#!/usr/bin/env bash
echo "cron-file-install-demo: $(date -Is)" >> "$HOME/cron_file_install_demo.log"
EOF
chmod +x "$HOME/bin/cron_file_install_demo.sh"
```

**Step 2: Test it manually**

```bash
"$HOME/bin/cron_file_install_demo.sh"
tail -n 3 "$HOME/cron_file_install_demo.log"
```

You should see a new line appended.

---

### Exercise B — Create a crontab file and install it

**Step 1: Make a crontab file (runs every 2 minutes)**

```bash
cat > "$HOME/mycrontab.demo" <<EOF
*/2 * * * * $HOME/bin/cron_file_install_demo.sh
EOF
```

**Step 2: Install it**

```bash
crontab "$HOME/mycrontab.demo"
```

**Step 3: Verify installed entries**

```bash
crontab -l
```

You should see the `*/2 * * * * ...` line.

**Step 4: Wait ~2–4 minutes, then verify it ran**

```bash
tail -n 10 "$HOME/cron_file_install_demo.log"
```

---

### Exercise C — Edit your crontab interactively (`crontab -e`)

This edits and installs in one step.

**Step 1: Open editor**

```bash
crontab -e
```

**Step 2: Make a safe small change**
For example, change the schedule from `*/2` to `*/5` (every 5 minutes), save, and exit.

**Step 3: Confirm**

```bash
crontab -l
```

If you make a syntax mistake, `crontab` usually reports the line and lets you retry.

---

### Exercise D — Remove your user crontab

To remove *your entire* crontab:

```bash
crontab -r
```

Confirm it’s gone:

```bash
crontab -l
```

---

## 3) System crontab files: `/etc/crontab` and `/etc/cron.d`

### 3.1 Why system cron exists

System maintenance tasks often run as `root`, but distros prefer managing them centrally using:

* `/etc/crontab` (global file)
* `/etc/cron.d/*` (drop-in cron files)

### 3.2 The key difference in format

User crontab lines are:

$$
\text{min hour dom mon dow command}
$$

System crontab lines add an extra field:

$$
\text{min hour dom mon dow \color{#000}{user} command}
$$

Example shape:

```text
42 6 * * * root /usr/local/bin/cleansystem > /dev/null 2>&1
```

That `root` field tells cron which user runs the command.

---

## 4) Hands-on: inspect system cron locations (read-only, safe)

> These commands **do not** modify system files.

### Exercise E — View `/etc/crontab` (if present)

```bash
sudo sed -n '1,200p' /etc/crontab
```

### Exercise F — List `/etc/cron.d` jobs (if present)

```bash
ls -l /etc/cron.d 2>/dev/null || echo "No /etc/cron.d directory on this system"
```

If there are files, preview one:

```bash
sudo sed -n '1,120p' /etc/cron.d/* 2>/dev/null | head -n 120
```

### Exercise G — See daily/weekly/monthly cron script directories

Many distros use these directories, triggered by entries in `/etc/crontab` or scripts like `run-parts`:

```bash
ls -l /etc/cron.hourly /etc/cron.daily /etc/cron.weekly /etc/cron.monthly 2>/dev/null
```

---

## 5) systemd timer units: a modern alternative to cron

### 5.1 Concept: two units working together

A **timer** schedules an activation, but the **service** defines the work.

$$
\texttt{.timer} \Rightarrow \text{triggers} \Rightarrow \texttt{.service}
$$

* `example.timer`: “When should it run?”
* `example.service`: “What should run?”

### 5.2 Why two units?

A timer is a reusable mechanism. It doesn’t contain the command; it points to the service unit.

---

## 6) Hands-on: create a timer + oneshot service you can observe

> This creates a user-level systemd timer (no root required) so it’s safe on most systems.
> You’ll see logs via `journalctl --user` and status via `systemctl --user`.

### Exercise H — Create a user service that writes to the journal

**Step 1: Create the service unit**

```bash
mkdir -p "$HOME/.config/systemd/user"
cat > "$HOME/.config/systemd/user/timerdemo.service" <<'EOF'
[Unit]
Description=Timer Demo Service (oneshot)

[Service]
Type=oneshot
ExecStart=/usr/bin/systemd-cat -t timerdemo echo "timerdemo fired at $(date -Is)"
EOF
```

What this does:

* Runs once and exits (`Type=oneshot`)
* Sends a log line to the journal with tag `timerdemo`

---

### Exercise I — Create a user timer that triggers the service every minute

**Step 1: Create the timer unit**

```bash
cat > "$HOME/.config/systemd/user/timerdemo.timer" <<'EOF'
[Unit]
Description=Timer Demo (runs every minute)

[Timer]
OnCalendar=*-*-* *:*:00
Unit=timerdemo.service

[Install]
WantedBy=timers.target
EOF
```

Meaning of `OnCalendar`:

$$
\text{every day, every hour, every minute, at second } 00
$$

---

### Exercise J — Load units, start the timer, and enable it

**Step 1: Reload user systemd so it sees the new units**

```bash
systemctl --user daemon-reload
```

**Step 2: Start the timer now**

```bash
systemctl --user start timerdemo.timer
```

**Step 3: Enable it so it starts automatically (for your user)**

```bash
systemctl --user enable timerdemo.timer
```

---

### Exercise K — Verify the timer schedule and observe runs

**Step 1: List your active timers**

```bash
systemctl --user list-timers --all | grep timerdemo || true
```

**Step 2: Wait 1–2 minutes, then check journal entries**

```bash
journalctl --user -t timerdemo -n 20
```

You should see lines like:

$$
\texttt{timerdemo fired at 2026-...}
$$

**Step 3: Check service execution history**

```bash
systemctl --user status timerdemo.service --no-pager
```

You’ll often see last run time and exit status.

---

### Exercise L — Stop and remove the demo

**Stop and disable timer**

```bash
systemctl --user stop timerdemo.timer
systemctl --user disable timerdemo.timer
```

**Remove unit files**

```bash
rm -f "$HOME/.config/systemd/user/timerdemo.timer" "$HOME/.config/systemd/user/timerdemo.service"
systemctl --user daemon-reload
```

---

## 7) Understanding the “race condition” note (why logs may not show a unit)

### 7.1 The issue (simplified)

If a service runs extremely fast and logs via certain paths (e.g., syslog logger), journald may not reliably attach `_SYSTEMD_UNIT` metadata to the message because mapping can depend on timing/process info.

### 7.2 Why the demo above avoids that

Using:

$$
\texttt{systemd-cat}
$$

writes directly into journald in a way that’s easy to trace, so you reliably see the tag (`-t timerdemo`) in:

```bash
journalctl --user -t timerdemo
```

---

## 8) Quick mental map

* **User crontab**: managed with `crontab -l/-e/-r` and install via `crontab file`
* **System cron**: `/etc/crontab` and `/etc/cron.d/*` (includes a “run as user” field)
* **systemd timers**: `.timer` schedules, `.service` executes; `Type=oneshot` is ideal for periodic tasks